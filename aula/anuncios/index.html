<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anuncios | Aula Virtual</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/style.css?v=20260211-8">
    <style>
        .aula-page { padding-top: 100px; background: #f4f4f4; min-height: 100vh; }
        .module { padding: 30px 10% 60px; max-width: 1100px; margin: 0 auto; }
        .module h1 { color: var(--primary); margin-bottom: 8px; }
        .module p { color: #555; }
        .module-card { background: var(--white); border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.06); padding: 22px; margin-top: 18px; }
        .module-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px; }

        /* Compose */
        .compose-form { display: none; }
        .compose-form.visible { display: block; }
        .compose-form label { display: block; font-weight: 600; margin-top: 14px; color: #333; font-size: .95rem; }
        .compose-form input[type="text"], .compose-form textarea {
            width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 8px;
            font-family: inherit; font-size: .95rem; margin-top: 4px; box-sizing: border-box;
        }
        .compose-form textarea { min-height: 140px; resize: vertical; }
        .compose-actions { display: flex; gap: 10px; margin-top: 18px; flex-wrap: wrap; }

        /* File upload area */
        .file-upload-area { border: 2px dashed #c5c5c5; border-radius: 12px; padding: 20px; text-align: center; margin-top: 8px; cursor: pointer; transition: .2s; background: #fafafa; }
        .file-upload-area:hover, .file-upload-area.dragover { border-color: var(--primary); background: #f0f4ff; }
        .file-upload-area i { font-size: 2rem; color: #aaa; margin-bottom: 6px; }
        .file-upload-area p { color: #888; font-size: .88rem; margin: 4px 0 0; }
        .file-upload-area input { display: none; }
        .upload-preview { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
        .upload-preview-item { background: #f0f4ff; border-radius: 8px; padding: 8px 12px; font-size: .85rem; display: flex; align-items: center; gap: 8px; }
        .upload-preview-item .remove-file { background: none; border: none; color: #c00; cursor: pointer; font-size: 1rem; padding: 0 4px; }
        .uploading-indicator { color: var(--primary); font-size: .85rem; margin-top: 8px; }

        /* Announcement cards */
        .ann-card { background: #fff; border-radius: 14px; box-shadow: 0 4px 16px rgba(0,0,0,0.06); padding: 24px; margin-top: 18px; border-left: 4px solid var(--primary); }
        .ann-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; flex-wrap: wrap; }
        .ann-title { font-size: 1.15rem; font-weight: 700; color: var(--primary); margin: 0; }
        .ann-meta { font-size: .82rem; color: #888; margin-top: 4px; }
        .ann-body { margin-top: 12px; line-height: 1.7; color: #333; white-space: pre-wrap; font-size: .95rem; }
        .ann-files { margin-top: 16px; }
        .ann-files-title { font-size: .88rem; font-weight: 600; color: #555; margin-bottom: 8px; }
        .ann-file { display: inline-flex; align-items: center; gap: 6px; background: #f0f4ff; padding: 8px 14px; border-radius: 8px; margin: 4px 6px 4px 0; font-size: .87rem; text-decoration: none; color: var(--primary); transition: .15s; }
        .ann-file:hover { background: #dde4ff; }
        .ann-file i { font-size: 1rem; }
        .ann-file-size { color: #999; font-size: .78rem; }
        .ann-delete { background: none; border: none; color: #c00; cursor: pointer; font-size: .85rem; padding: 4px 8px; border-radius: 6px; }
        .ann-delete:hover { background: #fff0f0; }
        .ann-delete-file { background: none; border: none; color: #c00; cursor: pointer; font-size: .78rem; margin-left: 4px; }

        /* Image preview in announcements */
        .ann-img-preview { max-width: 100%; max-height: 400px; border-radius: 10px; margin-top: 8px; cursor: pointer; transition: .2s; }
        .ann-img-preview:hover { opacity: .9; }
        .ann-video-preview { max-width: 100%; max-height: 400px; border-radius: 10px; margin-top: 8px; }

        .status-msg { padding: 10px 14px; border-radius: 8px; margin-top: 12px; font-size: .9rem; }
        .status-msg.success { background: #d3f9d8; color: #2b8a3e; }
        .status-msg.error { background: #ffe0e0; color: #c92a2a; }
        .empty-state { text-align: center; padding: 50px 20px; color: #888; }
        .empty-state i { font-size: 3rem; margin-bottom: 12px; display: block; color: #ddd; }
    </style>
</head>
<body class="aula-page is-auth">
    <header>
        <div class="logo">
            <img src="/imagenes/circuloabraham.png" alt="Logo Instituto Abraham Lincoln">
            INSTITUTO ABRAHAM LINCOLN
        </div>
        <nav>
            <ul>
                <li><a href="/">Inicio</a></li>
            </ul>
        </nav>
        <div class="nav-actions">
            <a class="btn btn-outline btn-logout" href="#">Cerrar Sesión</a>
        </div>
    </header>

    <main class="module">
        <h1><i class="fas fa-bullhorn" style="margin-right:8px;"></i>Anuncios</h1>
        <p id="welcomeUser" style="margin-top: 6px;"></p>

        <div class="module-actions" style="margin-top:12px; margin-bottom:0;">
            <button class="btn" id="btnCompose" style="display:none;">
                <i class="fas fa-plus"></i> Nuevo Anuncio
            </button>
            <a class="btn btn-outline" href="/aula">Volver al Aula</a>
        </div>

        <!-- Formulario de creación (solo admin) -->
        <div class="compose-form module-card" id="composeForm" style="background:#f8faff; border:1px solid #d0d7ff;">
            <h3 style="margin:0 0 4px; color:var(--primary); font-size:1.1rem;">
                <i class="fas fa-bullhorn" style="margin-right:6px;"></i>Crear anuncio
            </h3>
            <div id="composeStatus"></div>

            <label for="annTitle">Título *</label>
            <input type="text" id="annTitle" placeholder="Título del anuncio" maxlength="200">

            <label for="annBody">Contenido *</label>
            <textarea id="annBody" placeholder="Escribe el contenido del anuncio..."></textarea>

            <label>Archivos adjuntos <span style="font-weight:400; color:#999; font-size:.82rem;">(imágenes, videos, PDF — máx. 50 MB cada uno)</span></label>
            <div class="file-upload-area" id="fileDropArea">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Arrastra archivos aquí o <strong>haz clic para seleccionar</strong></p>
                <p style="font-size:.78rem; color:#aaa;">JPG, PNG, GIF, WebP, MP4, WebM, PDF</p>
                <input type="file" id="fileInput" multiple accept="image/jpeg,image/png,image/gif,image/webp,video/mp4,video/webm,application/pdf">
            </div>
            <div class="upload-preview" id="uploadPreview"></div>

            <div class="compose-actions">
                <button class="btn" id="btnPublish"><i class="fas fa-paper-plane"></i> Publicar Anuncio</button>
                <button class="btn btn-outline" id="btnCancelCompose">Cancelar</button>
            </div>
        </div>

        <!-- Lista de anuncios -->
        <div id="annList">
            <div class="empty-state"><i class="fas fa-spinner fa-spin"></i>Cargando anuncios...</div>
        </div>
    </main>

    <script src="/script.js?v=20260211-8"></script>
    <script>
    (() => {
        const $ = (sel) => document.querySelector(sel);
        const email = (localStorage.getItem('userEmail') || '').trim().toLowerCase();
        const role = (localStorage.getItem('userRole') || 'student').trim().toLowerCase();
        const userName = localStorage.getItem('userName') || '';
        const API = '/api/announcements';
        const isAdmin = role === 'admin';

        const welcomeEl = $('#welcomeUser');
        if (welcomeEl) welcomeEl.textContent = `Hola, ${userName || email}`;

        // Show compose button for admin only
        const btnCompose = $('#btnCompose');
        const composeForm = $('#composeForm');
        if (isAdmin && btnCompose) btnCompose.style.display = '';

        btnCompose?.addEventListener('click', () => composeForm.classList.toggle('visible'));
        $('#btnCancelCompose')?.addEventListener('click', () => {
            composeForm.classList.remove('visible');
            resetForm();
        });

        // ─── File handling ───
        let selectedFiles = [];

        const fileDropArea = $('#fileDropArea');
        const fileInput = $('#fileInput');
        const uploadPreview = $('#uploadPreview');

        fileDropArea?.addEventListener('click', () => fileInput.click());
        fileDropArea?.addEventListener('dragover', (e) => { e.preventDefault(); fileDropArea.classList.add('dragover'); });
        fileDropArea?.addEventListener('dragleave', () => fileDropArea.classList.remove('dragover'));
        fileDropArea?.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropArea.classList.remove('dragover');
            addFiles(e.dataTransfer.files);
        });
        fileInput?.addEventListener('change', () => { addFiles(fileInput.files); fileInput.value = ''; });

        function addFiles(fileList) {
            for (const f of fileList) {
                if (selectedFiles.length >= 10) break;
                if (f.size > 50 * 1024 * 1024) { alert(`"${f.name}" es demasiado grande (máx 50 MB).`); continue; }
                selectedFiles.push(f);
            }
            renderPreview();
        }

        function renderPreview() {
            uploadPreview.innerHTML = selectedFiles.map((f, i) => {
                const icon = f.type.startsWith('image/') ? 'fa-image' : f.type.startsWith('video/') ? 'fa-video' : 'fa-file-pdf';
                const size = f.size < 1024 * 1024 ? (f.size / 1024).toFixed(0) + ' KB' : (f.size / 1024 / 1024).toFixed(1) + ' MB';
                return `<div class="upload-preview-item">
                    <i class="fas ${icon}"></i>
                    <span>${esc(f.name)}</span>
                    <span class="ann-file-size">(${size})</span>
                    <button class="remove-file" data-idx="${i}" title="Quitar">&times;</button>
                </div>`;
            }).join('');
            uploadPreview.querySelectorAll('.remove-file').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectedFiles.splice(Number(btn.dataset.idx), 1);
                    renderPreview();
                });
            });
        }

        function resetForm() {
            $('#annTitle').value = '';
            $('#annBody').value = '';
            selectedFiles = [];
            renderPreview();
            $('#composeStatus').innerHTML = '';
        }

        // ─── Publish ───
        $('#btnPublish')?.addEventListener('click', async () => {
            const title = ($('#annTitle')?.value || '').trim();
            const body = ($('#annBody')?.value || '').trim();
            if (!title || !body) return showStatus('composeStatus', 'Título y contenido son obligatorios.', 'error');

            const btnPub = $('#btnPublish');
            btnPub.disabled = true;
            btnPub.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publicando...';

            try {
                // 1) Crear anuncio
                const r = await fetch(`${API}?action=create&email=${encodeURIComponent(email)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, body })
                });
                const d = await r.json();
                if (!r.ok) { showStatus('composeStatus', d.message || 'Error al crear.', 'error'); return; }

                const annId = d.announcement_id;

                // 2) Subir archivos
                if (selectedFiles.length && annId) {
                    showStatus('composeStatus', `Subiendo ${selectedFiles.length} archivo(s)...`, 'success');
                    for (let i = 0; i < selectedFiles.length; i++) {
                        const fd = new FormData();
                        fd.append('file', selectedFiles[i]);
                        const ur = await fetch(`${API}?action=upload&announcement_id=${annId}&email=${encodeURIComponent(email)}`, {
                            method: 'POST', body: fd
                        });
                        if (!ur.ok) {
                            const ud = await ur.json();
                            showStatus('composeStatus', `Error al subir "${selectedFiles[i].name}": ${ud.message}`, 'error');
                        }
                    }
                }

                showStatus('composeStatus', '¡Anuncio publicado!', 'success');
                resetForm();
                setTimeout(() => { composeForm.classList.remove('visible'); loadAnnouncements(); }, 1200);
            } catch (e) {
                showStatus('composeStatus', 'Error de conexión.', 'error');
            } finally {
                btnPub.disabled = false;
                btnPub.innerHTML = '<i class="fas fa-paper-plane"></i> Publicar Anuncio';
            }
        });

        // ─── Helpers ───
        function showStatus(id, text, type) {
            const el = $(`#${id}`);
            if (!el) return;
            el.innerHTML = `<div class="status-msg ${type}">${text}</div>`;
            if (type === 'success') setTimeout(() => el.innerHTML = '', 5000);
        }

        function formatDate(val) {
            if (!val) return '';
            const iso = val.includes('T') ? val : val.replace(' ', 'T') + 'Z';
            const d = new Date(iso);
            if (isNaN(d.getTime())) return val;
            return d.toLocaleString('es-MX', { dateStyle: 'long', timeStyle: 'short' });
        }

        function formatSize(bytes) {
            if (!bytes) return '';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(0) + ' KB';
            return (bytes / 1024 / 1024).toFixed(1) + ' MB';
        }

        function fileIcon(type) {
            if (type.startsWith('image/')) return 'fa-image';
            if (type.startsWith('video/')) return 'fa-video';
            if (type === 'application/pdf') return 'fa-file-pdf';
            return 'fa-file';
        }

        function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

        // ─── Load announcements ───
        async function loadAnnouncements() {
            const list = $('#annList');
            try {
                const r = await fetch(`${API}?email=${encodeURIComponent(email)}`);
                if (!r.ok) { list.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i>Error al cargar anuncios.</div>'; return; }
                const d = await r.json();
                const anns = d.announcements || [];
                if (!anns.length) {
                    list.innerHTML = '<div class="empty-state"><i class="fas fa-bullhorn"></i>No hay anuncios publicados aún.</div>';
                    return;
                }

                list.innerHTML = anns.map(a => {
                    let filesHtml = '';
                    if (a.files && a.files.length) {
                        // Separate inline previews (images/videos) from download links
                        const images = a.files.filter(f => f.file_type.startsWith('image/'));
                        const videos = a.files.filter(f => f.file_type.startsWith('video/'));
                        const others = a.files.filter(f => !f.file_type.startsWith('image/') && !f.file_type.startsWith('video/'));

                        let previews = '';
                        images.forEach(f => {
                            const url = `${API}?action=file&key=${encodeURIComponent(f.file_key)}`;
                            previews += `<a href="${url}" target="_blank"><img class="ann-img-preview" src="${url}" alt="${esc(f.file_name)}" loading="lazy"></a>`;
                            if (isAdmin) previews += `<button class="ann-delete-file" data-fileid="${f.id}" title="Eliminar archivo"><i class="fas fa-trash-alt"></i></button>`;
                        });
                        videos.forEach(f => {
                            const url = `${API}?action=file&key=${encodeURIComponent(f.file_key)}`;
                            previews += `<video class="ann-video-preview" controls preload="metadata"><source src="${url}" type="${f.file_type}"></video>`;
                            if (isAdmin) previews += `<button class="ann-delete-file" data-fileid="${f.id}" title="Eliminar archivo"><i class="fas fa-trash-alt"></i></button>`;
                        });

                        let links = '';
                        others.forEach(f => {
                            const url = `${API}?action=file&key=${encodeURIComponent(f.file_key)}`;
                            links += `<a class="ann-file" href="${url}" target="_blank"><i class="fas ${fileIcon(f.file_type)}"></i>${esc(f.file_name)} <span class="ann-file-size">(${formatSize(f.file_size)})</span></a>`;
                            if (isAdmin) links += `<button class="ann-delete-file" data-fileid="${f.id}" title="Eliminar archivo"><i class="fas fa-trash-alt"></i></button>`;
                        });

                        if (previews || links) {
                            filesHtml = `<div class="ann-files"><div class="ann-files-title"><i class="fas fa-paperclip"></i> Archivos adjuntos</div>${previews}${links}</div>`;
                        }
                    }

                    const deleteBtn = isAdmin ? `<button class="ann-delete" data-annid="${a.id}"><i class="fas fa-trash"></i> Eliminar</button>` : '';

                    return `<div class="ann-card" data-id="${a.id}">
                        <div class="ann-header">
                            <div>
                                <h3 class="ann-title">${esc(a.title)}</h3>
                                <div class="ann-meta"><i class="fas fa-user-shield" style="margin-right:4px;"></i>${esc(a.admin_name || 'Admin')} — ${formatDate(a.created_at)}</div>
                            </div>
                            ${deleteBtn}
                        </div>
                        <div class="ann-body">${esc(a.body)}</div>
                        ${filesHtml}
                    </div>`;
                }).join('');

                // Delete announcement
                list.querySelectorAll('.ann-delete').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (!confirm('¿Eliminar este anuncio y todos sus archivos?')) return;
                        const annId = btn.dataset.annid;
                        try {
                            const r = await fetch(`${API}?action=delete&email=${encodeURIComponent(email)}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ announcement_id: Number(annId) })
                            });
                            if (r.ok) loadAnnouncements();
                            else { const d = await r.json(); alert(d.message || 'Error'); }
                        } catch { alert('Error de conexión.'); }
                    });
                });

                // Delete individual file
                list.querySelectorAll('.ann-delete-file').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (!confirm('¿Eliminar este archivo?')) return;
                        const fileId = btn.dataset.fileid;
                        try {
                            const r = await fetch(`${API}?action=delete_file&email=${encodeURIComponent(email)}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ file_id: Number(fileId) })
                            });
                            if (r.ok) loadAnnouncements();
                            else { const d = await r.json(); alert(d.message || 'Error'); }
                        } catch { alert('Error de conexión.'); }
                    });
                });

            } catch {
                list.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i>Error de conexión.</div>';
            }
        }

        loadAnnouncements();
    })();
    </script>
</body>
</html>
